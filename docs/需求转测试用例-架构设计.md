# 架构设计文档：智能感知测试引擎 (Intelligent Sense Test Engine)

## 1. 业务目标

- **自动化设计：** 从自然语言需求直接生成测试用例。
- **代码感知：** 通过 Git Diff 分析受影响的逻辑，捕捉“想不到”的回归风险。
- **高稳定性：** 优先使用 Zerostep AI 定位，自动切换 Playwright 选择器作为兜底。
- **全覆盖：** 结合启发式策略，覆盖功能、交互、异常、性能等维度。

---

## 2. 总体架构图

系统的核心分为四个层次：**数据采集层、逻辑大脑、适配转换层、执行与反馈层**。

---

## 3. 核心模块详细设计

### 3.1 数据采集层 (Input & Context)

这是系统的“感知器官”，负责收集所有必要的信息以构建上下文。

- **Requirement Analyzer:** 接收自然语言需求，提取核心业务逻辑。
  步骤一：需求解构 (Requirement Decomposition)
  输入： “更新了图片预览组件，支持缩放、切换、长图适配。”
  AI 角色： 产品经理 / 业务分析师
  任务： 将一句话需求拆解为具体的“功能点列表”。
  Prompt 示例:
  “你是一个资深产品经理。用户输入了需求描述：'{user_input}'。请分析该组件通常隐含的显性功能和隐性功能。不要生成测试用例，只列出功能点和预期行为。
  例如图片预览通常包含：打开动画、关闭方式（点击X、点击遮罩、ESC键）、手势支持、加载状态等。”

- **Git Diff Inspector:** \* 分析变更的文件列表（File Scope）。
- 识别关键函数、组件 Props 或状态变量的改动。

- **Project Mapper:** 维护组件与路由/页面的映射关系（通过静态分析 `routes.ts` 或文件命名约定）。

### 3.2 逻辑大脑 (Intelligence Layer - LLM)

这是系统的决策中心，采用**发散-收敛（Diverge-Converge）**模型。

- **Impact Analyzer (发散):** 对比需求与代码改动，推断出“副作用区域”。例如：改动了缩放逻辑，则必须测试旋转和边界溢出。
- **Heuristic Case Generator:** 应用启发式模型（输入域、异常、交互、环境等维度）生成地毯式测试点。
- **Strategy Optimizer (收敛):** 对生成的测试点进行去重、优先级排序，并转化为 **统一指令流 (Unified Instruction Stream)**。
- 步骤二：多维视角生成 (Multi-Perspective Generation) —— 这是覆盖“想不到”的关键
  这一步你需要并行调用 LLM 3-4 次，每次赋予它不同的“人格”或“测试视角”。
  视角 A：常规功能测试员 (Happy Path)
  关注：正常打开、正常缩放、正常切换、长图显示。
  视角 B：破坏性测试员 (Chaos Engineer / Edge Cases)
  关注：你提到的“想不到”的地方往往在这里。
  Prompt 关键词： 网络断开、图片加载失败、图片超大（100MB）、格式不支持（TIFF/WebP）、零宽高的图片、连续快速点击、内存泄漏。
  视角 C：交互与体验测试员 (UX/Interaction)
  关注：模拟真实用户。
  Prompt 关键词： 双指缩放、旋转手势、滑动切换的阻尼感、浏览器回退键干扰（你提到的）、屏幕旋转、暗黑模式适配。
  视角 D：安全与性能测试员
  关注：图片链接注入脚本（XSS）、超长文件名、并发加载多张大图。

- 步骤三：合并与结构化 (Merge & Structure)
  输入： 上述所有视角的输出。
  AI 角色： 测试主管 (QA Lead)
  任务： 去重、分类，并将其转换为你的执行层（Zerostep/Playwright）可理解的 JSON 格式。

### 3.3 适配器层 (Hybrid Adapter)

将逻辑指令转换为可执行代码的中间件。

- **Zerostep Provider:** 将语义描述（如 "Zoom the image"）转化为 Zerostep 的 `ai()` 调用。
- **Playwright Provider:** 根据代码中的 Class/ID 或历史数据，提供传统的 CSS/XPath 定位支持。
- **Fallback Logic:** 运行时的保护机制。若 AI 定位失败，自动尝试 Playwright 定位。

### 3.4 执行与反馈层 (Runtime & Feedback)

- **Engine:** 基于 Playwright 的浏览器运行环境，通过 `utils/fixture.js` 提供 `{ page, ai }` 统一上下文。
- **AI Fixture:** 所有测试文件统一使用 `utils/fixture.js`，集成 `@zerostep/playwright` 的 `aiFixture`，确保 ZeroStep AI 兜底能力全局可用。
- **Observer:** 监控执行过程，记录截图、网络请求和控制台错误。
- **Self-Healer:** 若执行失败，将错误日志回传给"逻辑大脑"进行修复建议。

**三种执行模式：**

| 模式         | 适用场景               | 执行路径                                                    |
| ------------ | ---------------------- | ----------------------------------------------------------- |
| 全流程模式   | 登录、搜索等端到端场景 | `runWorkflow(prompt, {page, ai})` → LLM 解析 → adapter 执行 |
| 需求管线模式 | 需求→用例→执行         | `generateCases()` → `runTestCase()` → `runWorkflow()`       |
| 组件精确模式 | 图片预览等 UI 组件测试 | `executeInstruction()` 直接构造指令 + Playwright 原生断言   |

---

## 4. 关键工作流 (Workflow)

| 阶段        | 动作描述                                        | 输出产物               |
| ----------- | ----------------------------------------------- | ---------------------- |
| **1. 输入** | 用户提交需求描述，系统自动拉取当前分支 Git Diff | Raw Context            |
| **2. 分析** | LLM 分析代码变更点及其在 UI 上的体现位置        | Impact Report          |
| **3. 生成** | 结合“发散思维”生成覆盖全方位的测试场景          | Test Case Suite (JSON) |
| **4. 转换** | 将 JSON 指令流映射为混合定位代码                | Executable Script      |
| **5. 执行** | 在浏览器中运行，AI 优先，代码兜底               | Test Report & Logs     |

---

## 5. 技术栈推荐

- **语言:** Node.js / Python (Playwright 对两者的支持都很出色)。
- **AI 接口:** GPT-4o 或 Claude 3.5 Sonnet (具备极强的代码和逻辑分析能力)。
- **定位增强:** [Zerostep](https://github.com/zerostep-ai/zerostep)。
- **静态分析:** `ts-morph` 或 `tree-sitter` (用于解析代码结构)。

---

## 6. 设计亮点总结

> **1. 灰盒测试闭环：** 结合了白盒的代码改动与黑盒的需求描述，解决了 AI 盲目生成用例的问题。
> **2. 启发式覆盖：** 模拟资深测试专家的思维框架，自动补齐网络中断、手势冲突、浏览器回退等"想不到"的边缘场景。
> **3. 弹性执行机制：** 通过 Zerostep 和 Playwright 的双结合，既保证了编写效率（语义化），又保证了生产环境的稳定性（选择器兜底）。
> **4. 统一测试架构：** 所有测试文件统一使用 `utils/fixture.js` 提供的 `{ page, ai }` 上下文。全流程测试走 `runWorkflow()`，组件精确测试走 `executeInstruction()` + Playwright 原生断言，确保 AI 兜底能力贯穿整个测试体系。
> **5. 分层混合策略：** 交互操作（点击/导航/验证）通过适配器执行获得 AI 兜底，精确断言（CSS 计算样式/DOM 属性/坐标操作）使用 Playwright 原生 API，实现"最佳工具做最佳事"。
