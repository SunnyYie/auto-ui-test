# 需求转测试用例 — MVP 验证记录

## 项目概述

验证"从自然语言需求到自动化测试执行"的完整链路：

```
需求描述 + Git Diff → 需求解构 → 多视角用例生成 → 指令流转换 → Playwright 执行
```

## 新增模块

| 模块              | 文件                          | 职责                                     |
| ----------------- | ----------------------------- | ---------------------------------------- |
| Git Diff 分析器   | `api/git-analyzer.js`         | 解析 git diff，提取变更文件、函数、组件  |
| 需求解构器        | `api/requirement-analyzer.js` | 调用 LLM 将需求拆解为功能点列表          |
| 多视角用例生成器  | `api/case-generator.js`       | 4 大视角并行生成 + 合并去重              |
| 用例→指令流转换器 | `api/case-to-workflow.js`     | 将用例转为 prompt，复用 runWorkflow 执行 |

---

## 验证场景

**模拟需求**: "登录页面增加了表单验证（用户名必填、密码最少6位）、登录按钮 loading 状态、记住密码选项、密码可见性切换、错误提示"

**模拟 Git Diff**: `LoginPage.vue` 新增 26 行（表单验证规则、loading 状态、记住密码、错误处理）

**目标页面**: http://bianji.ai-editor.chat/login

---

## 第 1 轮验证

- **时间**: 2026-02-12
- **状态**: ✅ 测试通过（全流程跑通）
- **总耗时**: 1.7 min

### 各阶段结果

| 阶段           | 结果   | 耗时  | 详情                               |
| -------------- | ------ | ----- | ---------------------------------- |
| Git Diff 分析  | ✅     | <10ms | 1 文件, +26/-3 行, 组件: LoginPage |
| 需求解构       | ✅     | ~8s   | 6 个功能点 (5 显性 + 1 隐性)       |
| 多视角用例生成 | ✅     | ~35s  | 11 个用例 (happy_path=6, chaos=5)  |
| Prompt 转换    | ✅     | <10ms | 11 个 prompt                       |
| 用例执行       | ⚠️ 4/5 | ~20s  | 第 5 步 verify 失败 (loading 时序) |

### 需求解构结果 (6 个功能点)

| ID  | 功能点                | 类型     | 优先级 |
| --- | --------------------- | -------- | ------ |
| F1  | 用户名必填验证        | explicit | high   |
| F2  | 密码长度验证          | explicit | high   |
| F3  | 登录按钮 Loading 状态 | explicit | high   |
| F4  | 记住密码功能          | explicit | medium |
| F5  | 密码可见性切换        | explicit | medium |
| F6  | 错误提示展示          | implicit | high   |

**亮点**: LLM 从代码 diff 的 `catch` 块推断出了隐性功能 F6（错误提示展示）

### 多视角用例生成结果 (11 个用例)

**功能测试员视角 (6 个)**:

- TC_001: 验证用户名为空时的错误提示 (P0)
- TC_004: 验证正常登录流程 (P1)
- TC_005: 验证登录按钮 Loading 状态 (P1)
- TC_006: 验证密码长度不足时的错误提示 (P1)
- TC_009: 验证记住密码功能 (P2)
- TC_010: 验证密码可见性切换 (P2)

**破坏性测试员视角 (5 个)**:

- TC_002: 快速多次点击提交按钮 (P0)
- TC_003: 空输入提交与必填项验证 (P0)
- TC_007: 超长用户名和边界值密码 (P2)
- TC_008: 模拟登录失败错误提示 (P1)
- TC_011: SQL注入与XSS特殊字符 (P1)

### 用例执行详情 (TC_001)

执行了第一个 P0 用例 "验证用户名为空时的错误提示"：

| 步骤 | 操作                  | 结果             | 耗时    |
| ---- | --------------------- | ---------------- | ------- |
| 1    | navigate 登录页       | ✅ 预执行跳过    | 0ms     |
| 2    | input 密码 123456     | ✅ Playwright    | 58ms    |
| 3    | click 登录按钮        | ✅ AI 兜底       | 10684ms |
| 4    | verify 用户名错误提示 | ✅ AI 验证       | ~2s     |
| 5    | verify 表单验证失败   | ❌ AI 返回 false | 2267ms  |

### 发现的问题

1. **button[type='submit'] 选择器不对** — LLM 生成的 `button[type='submit']` 在该页面不存在（Element UI 使用 `button[type='button']`），AI 兜底成功但耗时 10s
2. **loading 状态验证失败** — 验证"按钮保持禁用状态"失败，因为登录操作已经完成，loading 状态是瞬态的，无法在执行后验证
3. **LLM 返回格式不稳定** — 偶尔 LLM 在 JSON 前添加非 JSON 前缀文本（如 "特兰普JSON输出："），现有 extractJSON 能处理但不够优雅

### 关键验证结论

1. ✅ **完整链路可用** — 从需求文本到自动化执行的 5 个阶段全部跑通
2. ✅ **需求解构质量高** — LLM 准确拆出 6 个功能点，包含 1 个从代码推断的隐性功能
3. ✅ **多视角发散有效** — 2 个视角并行生成 11 个用例，覆盖功能/边缘/安全维度
4. ✅ **用例→Prompt 转换正确** — 所有 11 个用例成功转为可执行 prompt
5. ⚠️ **执行层需要优化** — 选择器问题和时序验证是已知瓶颈

---

## 第 2 轮验证 — Git Analyzer v2 深度分析

- **时间**: 2026-02-12
- **状态**: ✅ 26/26 断言全部通过
- **总耗时**: <1s（纯本地解析，无 LLM 调用）

### 优化内容

三大升级：

#### 1. 文件智能分类

将变更文件自动归类为 8 大类别，每类附带影响分析标签：

| 分类                     | 标签                           | 测试策略                              |
| ------------------------ | ------------------------------ | ------------------------------------- |
| style (CSS/SCSS/Less)    | UI兼容性, 样式回归, 响应式布局 | 视觉回归测试，跨浏览器/设备 UI 一致性 |
| component (Vue/JSX/TSX)  | 组件功能, 交互行为, Props接口  | 组件功能测试，Props 边界值            |
| state (Store/Vuex/Pinia) | 状态流转, 数据一致性, 副作用   | 状态流转正确性，跨组件数据一致性      |
| util (工具函数)          | 工具函数, 下游回归, 公共逻辑   | 回归所有引用该函数的组件              |
| api (接口层)             | 接口调用, 数据格式, 错误处理   | 接口调用、响应处理、错误码            |
| router                   | 页面跳转, 路由守卫, 权限控制   | 导航行为、权限验证                    |
| hook                     | 组合逻辑, 状态共享, 副作用     | 组合逻辑、状态共享                    |
| config                   | 配置变更, 全局影响             | 全局影响范围                          |

#### 2. Props/接口变更检测

精确识别三类变更：

- **新增 Props**: `onRotate: Function`, `showToolbar: Boolean`, `maxZoom: Number`
- **修改 Props**: `width: Number → String`（类型变更）
- **Emit 事件**: 新增 `rotate`, `zoom` 事件
- **函数签名**: `processImage(file, {maxWidth})` → `processImage(file, {maxWidth, quality?, format?})`

#### 3. 依赖引用关系分析

通过 `grep` 扫描项目源码中的 `import/require`，计算回归影响范围：

- 如果 `utils/image-processor.ts` 改了 → 自动发现所有引用它的组件（预览、上传、头像）
- 输出回归清单表格，供 LLM 生成回归测试用例

### 测试场景

**模拟 5 个文件变更**:

| 文件                 | 分类      | 变更内容                                          |
| -------------------- | --------- | ------------------------------------------------- |
| `ImagePreview.vue`   | component | +3 props, 修改 width 类型, +2 emit 事件           |
| `image-preview.scss` | style     | flex 布局, toolbar 样式, 过渡动画                 |
| `image-processor.ts` | util      | processImage 签名变更, 新增 rotateImage           |
| `imageStore.ts`      | state     | 新增 rotation/scale 状态, 2 个 action             |
| `imageService.js`    | api       | uploadImage 增加 compress 参数, 新增 getImageMeta |

### 验证结果 (26/26)

| 测试组                  | 断言数 | 结果        |
| ----------------------- | ------ | ----------- |
| 文件智能分类            | 10     | ✅ 全部通过 |
| Props/Emit/签名变更检测 | 10     | ✅ 全部通过 |
| formatDiffContext 输出  | 6      | ✅ 全部通过 |

关键检测结果：

- ✅ Vue 组件 → `component` 分类, 标签含 `组件功能`, `Props接口变更`, `事件接口变更`, `状态流转`
- ✅ SCSS → `style` 分类, 标签含 `UI兼容性`
- ✅ 工具函数 → `util` 分类, 标签含 `下游回归`, `函数签名变更`
- ✅ Store → `state` 分类, 标签含 `状态流转`
- ✅ Props: 正确识别新增 `onRotate`/`showToolbar`/`maxZoom`, 修改 `width: Number→String`
- ✅ Emit: 正确识别新增 `rotate`/`zoom` 事件
- ✅ 函数签名: `processImage` 参数扩展被检测

### Bug 修复记录

| Bug            | 原因                                                       | 修复                                   |
| -------------- | ---------------------------------------------------------- | -------------------------------------- |
| Props 未检测到 | `isInPropsContext` 只检查 +/- 行，但 `props: {` 是上下文行 | 改为收集 hunk 全部行（含上下文）再判断 |

---

## 性能分析

| 阶段             | 耗时   | LLM 调用 | 说明                              |
| ---------------- | ------ | -------- | --------------------------------- |
| Git Diff v2 分析 | <10ms  | 0        | 纯本地解析，含分类+Props+签名检测 |
| 依赖引用分析     | ~100ms | 0        | grep 扫描源码，项目规模敏感       |
| 需求解构         | ~8s    | 1        | 单次 LLM 调用                     |
| 多视角生成       | ~35s   | 2 (并行) | 2 个视角并行                      |
| Prompt 转换      | <10ms  | 0        | 纯本地                            |
| 用例执行         | ~20s   | 1+       | LLM 解析 + 执行                   |

### 优化方向

1. **指令缓存** — 相同 prompt 缓存后执行从 20s 降到 2-4s
2. **4 视角全开** — 并行不增加总时间
3. **Props 变更 → 自动生成测试** — Props 变更清单直接注入 case-generator，确保每个新 prop 都有对应测试
4. **回归清单 → 自动回归** — 依赖分析结果自动触发受影响组件的回归测试
